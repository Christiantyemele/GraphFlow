<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://esm.sh https://unpkg.com 'unsafe-inline';" />
  <title>Excalidraw Headless Renderer</title>
  <style>
    html, body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    // Puppeteer will inject window.__SCENE__ and window.__TARGET__ before this page runs
    window.__DONE__ = false;
  </script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@excalidraw/excalidraw@0.17.6/dist/excalidraw.production.min.js"></script>
  <script>

    async function render() {
      try {
        const scene = window.__SCENE__ || { elements: [], appState: { viewBackgroundColor: '#ffffff' }, files: {} };
        const target = window.__TARGET__ || 'svg';

        if (target === 'svg') {
          const svgEl = await window.ExcalidrawLib.exportToSvg({
            elements: scene.elements || [],
            appState: scene.appState || { viewBackgroundColor: '#ffffff' },
            files: scene.files || {}
          });
          document.body.appendChild(svgEl);
          window.__SVG__ = svgEl.outerHTML;
          window.__DONE__ = true;
        } else if (target === 'png') {
          const canvas = await window.ExcalidrawLib.exportToCanvas({
            elements: scene.elements || [],
            appState: scene.appState || { viewBackgroundColor: '#ffffff' },
            files: scene.files || {}
          });
          window.__PNG_BASE64__ = canvas.toDataURL('image/png');
          window.__DONE__ = true;
        } else {
          console.error('Unknown target', target);
          window.__DONE__ = true;
        }
      } catch (e) {
        console.error('Render error', e);
        window.__DONE__ = true;
      }
    }
    // Expose a trigger for Puppeteer
    window.renderExcalidraw = render;
  </script>
</body>
</html>
